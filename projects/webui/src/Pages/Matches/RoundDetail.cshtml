@page "{matchId:guid}/{roundNumber:int}"
@model SemanticPoker.WebUI.Pages.Matches.RoundDetailModel
@{
    ViewData["Title"] = $"Round {Model.Round?.RoundNumber}";
}

@if (Model.Round is null)
{
    <div class="alert alert-danger">Round not found.</div>
    return;
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-page="/Index">Dashboard</a></li>
        <li class="breadcrumb-item">
            <a asp-page="/Matches/Detail" asp-route-id="@Model.MatchId">
                Match @Model.MatchId.ToString()[..8]
            </a>
        </li>
        <li class="breadcrumb-item active">Round @Model.Round.RoundNumber</li>
    </ol>
</nav>

<h1><i class="bi bi-dice-5"></i> Round @Model.Round.RoundNumber</h1>
<p class="text-muted">Architect: <strong>@Model.Round.ArchitectModelId</strong></p>

<!-- Door Layout -->
<div class="card mb-4">
    <div class="card-header"><h5 class="mb-0">Door Layout</h5></div>
    <div class="card-body">
        <div class="d-flex gap-3 justify-content-center">
            @foreach (var label in new[] { 'A', 'B', 'C', 'D', 'E' })
            {
                var doorClass = label == Model.Round.TreasureDoor ? "door-treasure" :
                               label == Model.Round.TrapDoor ? "door-trap" : "door-empty";
                var doorIcon = label == Model.Round.TreasureDoor ? "bi-gem" :
                              label == Model.Round.TrapDoor ? "bi-exclamation-triangle" : "bi-dash";
                var doorLabel = label == Model.Round.TreasureDoor ? "Treasure" :
                               label == Model.Round.TrapDoor ? "Trap" : "Empty";
                <div class="door-card @doorClass">
                    <div class="fs-4">@label</div>
                    <i class="bi @doorIcon"></i>
                    <small>@doorLabel</small>
                </div>
            }
        </div>
    </div>
</div>

<!-- Sentences -->
<div class="card mb-4">
    <div class="card-header"><h5 class="mb-0">Shuffled Sentences</h5></div>
    <div class="card-body">
        @foreach (var sentence in Model.Round.ShuffledSentences)
        {
            var sourceClass = sentence.Source == SentenceSource.Engine ? "sentence-engine" : "sentence-architect";
            <div class="mb-3 @sourceClass">
                <div class="d-flex justify-content-between">
                    <span>@(sentence.Index + 1). @sentence.Text</span>
                    <span>
                        <span class="badge @(sentence.Source == SentenceSource.Engine ? "bg-success" : "bg-danger") status-badge">
                            @sentence.Source
                        </span>
                        @if (sentence.IsTruthful)
                        {
                            <span class="badge bg-info status-badge">True</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark status-badge">Deceptive</span>
                        }
                    </span>
                </div>
            </div>
        }
    </div>
</div>

<!-- Player Decisions -->
<div class="card">
    <div class="card-header"><h5 class="mb-0">Player Decisions</h5></div>
    <div class="card-body">
        @foreach (var decision in Model.Round.PlayerDecisions)
        {
            var outcomeClass = decision.DoorOutcome == DoorType.Treasure ? "border-warning" :
                              decision.DoorOutcome == DoorType.Trap ? "border-danger" : "border-secondary";
            <div class="card mb-3 @outcomeClass" style="border-width: 2px;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6>@decision.ModelId</h6>
                            <p class="mb-1">
                                Chose: <strong>Door @decision.ChosenDoor</strong>
                                <span class="badge @(decision.DoorOutcome == DoorType.Treasure ? "bg-warning text-dark" : decision.DoorOutcome == DoorType.Trap ? "bg-danger" : "bg-secondary")">
                                    @decision.DoorOutcome
                                </span>
                            </p>
                            @if (decision.Reasoning != null)
                            {
                                <p class="text-muted small mb-0"><em>@decision.Reasoning</em></p>
                            }
                        </div>
                        <div class="text-end">
                            <span class="@(decision.ScoreChange > 0 ? "score-positive" : decision.ScoreChange < 0 ? "score-negative" : "score-neutral") fs-4">
                                @(decision.ScoreChange > 0 ? "+" : "")@decision.ScoreChange
                            </span>
                            <br />
                            <small class="text-muted">@decision.ResponseTimeMs.ToString("F0")ms</small>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<div class="mt-3">
    <a asp-page="/Matches/Detail" asp-route-id="@Model.MatchId" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Match
    </a>
</div>
