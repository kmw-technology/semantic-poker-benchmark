#!/bin/bash
# =============================================================================
# Pre-Commit Hook - Security Check
# =============================================================================
# Blockiert Commits die gefÃ¤hrliche Patterns enthalten.
# Installation: git config core.hooksPath .githooks
# =============================================================================

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "ğŸ” Security Check..."

BLOCKED=0

# -----------------------------------------------------------------------------
# 1. GefÃ¤hrliche SQL-Patterns prÃ¼fen
# -----------------------------------------------------------------------------
echo -n "   Checking for dangerous SQL patterns... "

SQL_PATTERNS=(
    "DELETE\s+FROM"
    "DROP\s+TABLE"
    "DROP\s+DATABASE"
    "TRUNCATE\s+TABLE"
    "TRUNCATE\s+"
    "UPDATE\s+.*\s+SET\s+.*\s+WHERE\s+1\s*=\s*1"
    "DELETE\s+FROM\s+.*\s+WHERE\s+1\s*=\s*1"
)

for pattern in "${SQL_PATTERNS[@]}"; do
    if git diff --cached --diff-filter=ACMR | grep -iE "$pattern" > /dev/null 2>&1; then
        echo -e "${RED}BLOCKED!${NC}"
        echo -e "${RED}   âš ï¸  GefÃ¤hrliches SQL-Pattern gefunden: $pattern${NC}"
        echo "   Wenn dies beabsichtigt ist, nutze: git commit --no-verify"
        BLOCKED=1
        break
    fi
done

if [ $BLOCKED -eq 0 ]; then
    echo -e "${GREEN}OK${NC}"
fi

# -----------------------------------------------------------------------------
# 2. Hardcoded Secrets prÃ¼fen
# -----------------------------------------------------------------------------
echo -n "   Checking for hardcoded secrets... "

SECRET_PATTERNS=(
    "password\s*=\s*[\"'][^\"']+[\"']"
    "Password\s*=\s*[\"'][^\"']+[\"']"
    "api[_-]?key\s*=\s*[\"'][^\"']+[\"']"
    "apikey\s*=\s*[\"'][^\"']+[\"']"
    "secret\s*=\s*[\"'][^\"']+[\"']"
    "connectionstring.*password"
    "BEGIN\s+(RSA|DSA|EC|OPENSSH)\s+PRIVATE\s+KEY"
)

SECRET_BLOCKED=0
for pattern in "${SECRET_PATTERNS[@]}"; do
    MATCHES=$(git diff --cached --diff-filter=ACMR | grep -iE "$pattern" | grep -v "appsettings.Development.json" | grep -v "\.example" | grep -v "Configuration\[" | grep -v "GetConnectionString" | head -3)
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}BLOCKED!${NC}"
        echo -e "${RED}   âš ï¸  MÃ¶gliches Secret gefunden:${NC}"
        echo "$MATCHES" | head -3
        echo "   Wenn dies ein Platzhalter/Test ist, nutze: git commit --no-verify"
        BLOCKED=1
        SECRET_BLOCKED=1
        break
    fi
done

if [ $SECRET_BLOCKED -eq 0 ]; then
    echo -e "${GREEN}OK${NC}"
fi

# -----------------------------------------------------------------------------
# 3. Production-Keywords in gefÃ¤hrlichem Kontext
# -----------------------------------------------------------------------------
echo -n "   Checking for production references... "

if git diff --cached --diff-filter=ACMR | grep -iE "(delete|drop|truncate|update).*(production|prod\.|prod-)" > /dev/null 2>&1; then
    echo -e "${YELLOW}WARNING${NC}"
    echo -e "${YELLOW}   âš ï¸  Production-Referenz in gefÃ¤hrlichem Kontext gefunden${NC}"
    echo "   Bitte Ã¼berprÃ¼fen ob dies beabsichtigt ist."
else
    echo -e "${GREEN}OK${NC}"
fi

# -----------------------------------------------------------------------------
# 4. GroÃŸe Dateien prÃ¼fen (>5MB)
# -----------------------------------------------------------------------------
echo -n "   Checking for large files... "

LARGE_FILES=$(git diff --cached --diff-filter=ACMR --name-only | while read file; do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$SIZE" -gt 5242880 ]; then
            echo "$file ($((SIZE/1024/1024))MB)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo -e "${YELLOW}   âš ï¸  GroÃŸe Dateien gefunden:${NC}"
    echo "$LARGE_FILES"
else
    echo -e "${GREEN}OK${NC}"
fi

# -----------------------------------------------------------------------------
# 5. Sensitive Dateien prÃ¼fen
# -----------------------------------------------------------------------------
echo -n "   Checking for sensitive files... "

SENSITIVE_FILES=(
    "\.env$"
    "\.env\."
    "secrets\.json"
    "credentials\.json"
    "\.pem$"
    "\.key$"
    "\.pfx$"
    "id_rsa"
    "id_dsa"
    "id_ecdsa"
    "id_ed25519"
)

SENSITIVE_BLOCKED=0
for pattern in "${SENSITIVE_FILES[@]}"; do
    MATCHES=$(git diff --cached --diff-filter=ACMR --name-only | grep -E "$pattern" | grep -v "\.example" | grep -v "\.sample")
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}BLOCKED!${NC}"
        echo -e "${RED}   âš ï¸  Sensitive Datei wird committed:${NC}"
        echo "$MATCHES"
        echo "   Diese Dateien sollten in .gitignore sein!"
        BLOCKED=1
        SENSITIVE_BLOCKED=1
        break
    fi
done

if [ $SENSITIVE_BLOCKED -eq 0 ]; then
    echo -e "${GREEN}OK${NC}"
fi

# -----------------------------------------------------------------------------
# Ergebnis
# -----------------------------------------------------------------------------
echo ""
if [ $BLOCKED -eq 1 ]; then
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${RED}   COMMIT BLOCKIERT - Sicherheitsprobleme gefunden!${NC}"
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "   Optionen:"
    echo "   1. Probleme beheben und erneut committen"
    echo "   2. Wenn sicher: git commit --no-verify (VORSICHT!)"
    echo ""
    exit 1
else
    echo -e "${GREEN}âœ… Alle Sicherheitschecks bestanden${NC}"
    echo ""
    exit 0
fi
